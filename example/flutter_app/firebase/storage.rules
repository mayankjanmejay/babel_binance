rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isValidImageFile() {
      return request.resource.contentType.matches('image/.*');
    }

    function isValidDocumentFile() {
      return request.resource.contentType.matches('application/pdf') ||
             request.resource.contentType.matches('application/msword') ||
             request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document');
    }

    function isValidVideoFile() {
      return request.resource.contentType.matches('video/.*');
    }

    function isValidAudioFile() {
      return request.resource.contentType.matches('audio/.*');
    }

    function isUnderSizeLimit(maxSizeMB) {
      return request.resource.size < maxSizeMB * 1024 * 1024;
    }

    // User avatars - max 5MB
    match /avatars/{userId}/{fileName} {
      allow read: if true; // Public read
      allow write: if isOwner(userId) &&
                      isValidImageFile() &&
                      isUnderSizeLimit(5);
    }

    // User documents - max 10MB
    match /documents/{userId}/{fileName} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) &&
                      isValidDocumentFile() &&
                      isUnderSizeLimit(10);
    }

    // Trade screenshots - max 5MB
    match /trades/{userId}/{tradeId}/{fileName} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) &&
                      isValidImageFile() &&
                      isUnderSizeLimit(5);
    }

    // Video recordings - max 100MB for premium users
    match /recordings/video/{userId}/{fileName} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) &&
                      isValidVideoFile() &&
                      isUnderSizeLimit(100);
    }

    // Audio recordings - max 50MB
    match /recordings/audio/{userId}/{fileName} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) &&
                      isValidAudioFile() &&
                      isUnderSizeLimit(50);
    }

    // Portfolio exports - max 5MB
    match /exports/{userId}/{fileName} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) &&
                      isValidDocumentFile() &&
                      isUnderSizeLimit(5);
    }

    // Backup data - max 50MB
    match /backups/{userId}/{fileName} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) &&
                      isUnderSizeLimit(50);
    }

    // Public assets (read-only for all, write for authenticated users)
    match /public/{allPaths=**} {
      allow read: if true;
      allow write: if false; // Only backend/admin can write
    }

    // Temporary uploads - max 20MB, auto-delete after 24 hours
    match /temp/{userId}/{fileName} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) &&
                      isUnderSizeLimit(20);
      allow delete: if isOwner(userId);
    }

    // Default deny
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
